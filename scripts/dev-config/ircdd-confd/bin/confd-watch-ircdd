#! /bin/bash
set -eo pipefail

export ETCD_PORT=${ETCD_PORT:-4001}
export HOST_IP=${HOST_IP:-172.17.42.1}
export ETCD=$HOST_IP:$ETCD_PORT

# This hack is necessary since the getenv function is not in confd 0.6.3 (latest stable)
cp /etc/confd/templates/rethinkdb.tmpl /etc/confd/templates/rethinkdb.tmpl.base
echo "hostname: \"$CLUSTER_ADDR\"" | cat - /etc/confd/templates/rethinkdb.tmpl.base > /etc/confd/templates/rethinkdb.tmpl

echo "[ircdd] booting container. ETCD: $ETCD"

until confd -onetime -node $ETCD -config-file /etc/confd/conf.d/ircdd.toml; do
    echo "[ircdd] waiting for confd to create initial ircddconfiguration"
    sleep 5
done

echo "[ircdd] is now monitoring etcd for changes..."
echo "" > /var/log/confd.log
confd -interval 10 -node $ETCD -config-file /etc/confd/conf.d/ircdd.toml &> /var/log/confd.log &

echo "[ircdd] starting ircdd"
echo "" > /var/log/ircdd.log
twistd --logfile=/var/log/ircdd.log ircdd --config=/etc/ircdd/ircdd.yaml

tail -f /var/log/*.log
